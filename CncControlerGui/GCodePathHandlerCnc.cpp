#include "CncControl.h"
#include "CncPosition.h"
#include "GCodePathHandlerCnc.h"

//////////////////////////////////////////////////////////////////
GCodePathHandlerCnc::GCodePathHandlerCnc(CncControl* cnc) 
: GCodePathHandlerBase	()
, CncPathListRunner		(cnc)
{
//////////////////////////////////////////////////////////////////
	changeInputUnit(Unit::mm);
	
	// add the file parser to the runner setup
	// the rest is already set by CncPathListRunner(cnc)
	CncPathListRunner::Setup& setup = getSetup();
	setup.fileParser				= fileParser;
}
//////////////////////////////////////////////////////////////////
GCodePathHandlerCnc::~GCodePathHandlerCnc() {
//////////////////////////////////////////////////////////////////
}
//////////////////////////////////////////////////////////////////
bool GCodePathHandlerCnc::prepareWorkImpl() {
//////////////////////////////////////////////////////////////////
	return true;
}
//////////////////////////////////////////////////////////////////
bool GCodePathHandlerCnc::finishWorkImpl() {
//////////////////////////////////////////////////////////////////
	// execute the the last movement
	return initNextPath();
}
//////////////////////////////////////////////////////////////////
bool GCodePathHandlerCnc::initNextPath() {
//////////////////////////////////////////////////////////////////
	// execute already existing path list
	if ( onPhysicallyExecute(pathListMgr) == false )
		return false;

	// default processing
	if ( PathHandlerBase::initNextPath() == false )
		return false;

	const Trigger::NextPath tr;
	processTrigger(tr);
	
	return true;
}
//////////////////////////////////////////////////////////////////
void GCodePathHandlerCnc::switchToolState(bool state) {
//////////////////////////////////////////////////////////////////
	CncPathListRunner::onPhysicallySwitchToolState(state);
}
//////////////////////////////////////////////////////////////////
bool GCodePathHandlerCnc::processDwellIntern(int64_t microseconds) {
//////////////////////////////////////////////////////////////////
	processWait(microseconds);
	return true;
}
//////////////////////////////////////////////////////////////////
void GCodePathHandlerCnc::initNextClientId(long id) {
//////////////////////////////////////////////////////////////////
	processClientId(id);
}
//////////////////////////////////////////////////////////////////
bool GCodePathHandlerCnc::changeCurrentFeedSpeedXYZ(CncSpeedMode s, double value) {
//////////////////////////////////////////////////////////////////
	processFeedSpeed(s, value);
	return true;
}
//////////////////////////////////////////////////////////////////
bool GCodePathHandlerCnc::changeCurrentSpindleSpeed(double value) {
//////////////////////////////////////////////////////////////////
	processSpindleSpeed(value);
	return true;
}
//////////////////////////////////////////////////////////////////
bool GCodePathHandlerCnc::processLinearMove(bool alreadyRendered) {
//////////////////////////////////////////////////////////////////
	const CncPathListEntry& cpe = pathListMgr.addEntryAbs(currentPos.getX(), currentPos.getY(), currentPos.getZ(), alreadyRendered);
	logNextPathListEntry(cpe);
	
	return true;
}
