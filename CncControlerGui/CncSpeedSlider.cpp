#include <wx/gdicmn.h>
#include <wx/richtooltip.h>
#include "CncNumberFormatter.h"
#include "CncConfig.h"
#include "MainFrameProxy.h"
#include "CncSpeedSlider.h"

///////////////////////////////////////////////////////////////////
CncSpeedSlider::CncSpeedSlider(wxWindow* parent)
: CncSpeedSliderBase(parent)
, bShowvalue		(true)
, toolTipWindow		(NULL)
///////////////////////////////////////////////////////////////////
{
	setRange(0, 10000);
	setValue((float)(m_slider->GetMax() * 0.2));
	
	showUnit(true);
	showValue(true);
}
///////////////////////////////////////////////////////////////////
CncSpeedSlider::~CncSpeedSlider() {
///////////////////////////////////////////////////////////////////
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::enable(bool state) {
///////////////////////////////////////////////////////////////////
	m_slider->Enable(state);
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::showUnit(bool state) {
///////////////////////////////////////////////////////////////////
	m_lbSliderUinit->SetLabel( state ? "[mm/min]" : "");
	Refresh();
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::showValue(bool state) {
///////////////////////////////////////////////////////////////////
	bShowvalue = state;
	Refresh();
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::updateToolTip() {
///////////////////////////////////////////////////////////////////
	if ( toolTipWindow == NULL )
		return;
		
	const float pitch = 12.0;
	
	wxString tt("");
	
	tt.append(wxString::Format("%s [mm/min]\n",	CncNumberFormatter::toString((double)(m_slider->GetValue())),				1));
	tt.append(wxString::Format("%s [mm/sec]\n",	CncNumberFormatter::toString((double)(m_slider->GetValue()) / 60.0),		1));
	tt.append(wxString::Format("%s [rpm]\n",	CncNumberFormatter::toString((double)(m_slider->GetValue()) / pitch),		1));
	tt.append(wxString::Format("%s [rps]\n",	CncNumberFormatter::toString((double)(m_slider->GetValue()) / pitch / 60),	1));
	
	wxRichToolTip tip("Configured Speed:", tt);
	tip.SetIcon(wxICON_INFORMATION);
	tip.SetTimeout(3000);
	tip.ShowFor(toolTipWindow);
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::setRange(int min, int max) {
///////////////////////////////////////////////////////////////////
	if ( min < 0 )
		min = 0;
		
	if ( max < min )
		max = min;
	
	m_slider->SetRange(min, max);
	Refresh();
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::setValue(int value) {
///////////////////////////////////////////////////////////////////
	m_slider->SetValue(value);
	APP_PROXY::updateCncSpeed((float)(value), CncSpeedUserDefined);
	
	Refresh();
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::setValue(float value) {
///////////////////////////////////////////////////////////////////
	setValue((int)value);
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::autoConfigure() {
///////////////////////////////////////////////////////////////////
	setRange(0, (int) THE_CONFIG->getMaxSpeedXYZ_MM_MIN());
	setValue((float)(m_slider->GetMax() * 0.2));
	Refresh();
}
///////////////////////////////////////////////////////////////////
int CncSpeedSlider::getValueMM_MIN() {
///////////////////////////////////////////////////////////////////
	return m_slider->GetValue();
}
///////////////////////////////////////////////////////////////////
int CncSpeedSlider::getValueMM_SEC() {
///////////////////////////////////////////////////////////////////
	return round(((float)getValueMM_MIN()) / 60.0);
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::onChangeSlider(wxScrollEvent& event) {
///////////////////////////////////////////////////////////////////
	Refresh();
	
	APP_PROXY::updateCncSpeed((float)(getValueMM_MIN()), CncSpeedUserDefined);
	updateToolTip();
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::onChangedSlider(wxScrollEvent& event) {
///////////////////////////////////////////////////////////////////
	Refresh();
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::onThumbtrackSlider(wxScrollEvent& event) {
///////////////////////////////////////////////////////////////////
	Refresh();
}
///////////////////////////////////////////////////////////////////
void CncSpeedSlider::onPaint(wxPaintEvent& event) {
///////////////////////////////////////////////////////////////////
	m_lbSliderValue->ChangeValue(CncNumberFormatter::toString(getValueMM_MIN()));
}
